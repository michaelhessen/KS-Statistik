
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kundservice Bank - LF Bergslagen</title>
    
    <!-- Ikoner och manifest -->
    <link rel="icon" href="favicon-32x32.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.webmanifest">
    
    <!-- Chart.js från CDN (UMD build registrerar alla komponenter automatiskt) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* CSS-variabler för färgtema */
        :root {
            /* LF Bergslagen färger - ljust tema */
            --color-primary: #0b5cab;
            --color-primary-light: #1976d2;
            --color-primary-dark: #0d47a1;
            --color-accent: #d32f2f;
            --color-accent-light: #f44336;
            --color-success: #2e7d32;
            --color-warning: #f57c00;
            
            /* Neutral färger - ljust tema */
            --color-bg: #ffffff;
            --color-bg-alt: #f5f7fa;
            --color-surface: #ffffff;
            --color-surface-alt: #f8f9fb;
            --color-text: #1a1a1a;
            --color-text-secondary: #666666;
            --color-text-muted: #999999;
            --color-border: #e0e4e7;
            --color-border-light: #f0f2f5;
            
            /* Skuggor */
            --shadow-small: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-large: 0 8px 24px rgba(0,0,0,0.2);
            
            /* Övriga */
            --radius: 12px;
            --radius-small: 8px;
            --transition: all 0.3s ease;
        }
        
        [data-theme="dark"] {
            /* LF Bergslagen färger - mörkt tema */
            --color-primary: #4a90e2;
            --color-primary-light: #64b5f6;
            --color-primary-dark: #1976d2;
            --color-accent: #ef5350;
            --color-accent-light: #ff5722;
            --color-success: #4caf50;
            --color-warning: #ff9800;
            
            /* Neutral färger - mörkt tema */
            --color-bg: #121212;
            --color-bg-alt: #1a1a1a;
            --color-surface: #1e1e1e;
            --color-surface-alt: #2a2a2a;
            --color-text: #ffffff;
            --color-text-secondary: #cccccc;
            --color-text-muted: #999999;
            --color-border: #333333;
            --color-border-light: #444444;
            
            /* Skuggor för mörkt tema */
            --shadow-small: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-large: 0 8px 24px rgba(0,0,0,0.5);
        }
        
        /* Auto tema-detection */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                /* Samma som [data-theme="dark"] ovan */
                --color-primary: #4a90e2;
                --color-primary-light: #64b5f6;
                --color-primary-dark: #1976d2;
                --color-accent: #ef5350;
                --color-accent-light: #ff5722;
                --color-success: #4caf50;
                --color-warning: #ff9800;
                --color-bg: #121212;
                --color-bg-alt: #1a1a1a;
                --color-surface: #1e1e1e;
                --color-surface-alt: #2a2a2a;
                --color-text: #ffffff;
                --color-text-secondary: #cccccc;
                --color-text-muted: #999999;
                --color-border: #333333;
                --color-border-light: #444444;
                --shadow-small: 0 2px 4px rgba(0,0,0,0.3);
                --shadow-medium: 0 4px 12px rgba(0,0,0,0.4);
                --shadow-large: 0 8px 24px rgba(0,0,0,0.5);
            }
        }
        
        /* Reset och bas-stilar */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition);
        }
        
        /* Header */
        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            box-shadow: var(--shadow-small);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 1rem 0;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
        }
        
        .logo-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo-img {
            height: 60px;
            width: auto;
            display: block;
        }

        
        .title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-primary);
            margin: 0;
        }
        
        .theme-toggle {
            background: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-small);
            padding: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--color-text);
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            background: var(--color-primary);
            color: white;
        }

        .icon-button {
            background: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-small);
            padding: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--color-text);
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }

        .icon-button:hover {
            background: var(--color-primary);
            color: white;
        }
        
        /* Navigation tabs */
        .nav-tabs {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 73px;
            z-index: 99;
        }
        
        .nav-tabs-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            padding: 0 1rem;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            color: var(--color-text-secondary);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }
        
        .tab-button:hover:not(.active) {
            color: var(--color-text);
            background: var(--color-bg-alt);
        }
        
        /* Huvudlayout */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Samtalsflikar */
        .call-tab-button {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .call-tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }

        .call-tab-button:hover:not(.active) {
            color: var(--color-text);
            background: var(--color-bg-alt);
        }

        .call-tab-content {
            display: none;
        }

        .call-tab-content.active {
            display: block;
        }

        .call-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1rem;
        }

        .subtab-button {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .subtab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }

        .subtab-button:hover:not(.active) {
            color: var(--color-text);
            background: var(--color-bg-alt);
        }

        .subtab-content {
            display: none;
        }

        .subtab-content.active {
            display: block;
        }

        .subtabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1rem;
        }
        
        /* Kort-komponenter */
        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-small);
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: var(--shadow-medium);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--color-primary);
        }
        
        /* Form-element */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--color-text);
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-small);
            background: var(--color-bg);
            color: var(--color-text);
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(11, 92, 171, 0.1);
        }
        
        /* Radio buttons och checkboxes */
        .radio-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .radio-item input[type="radio"] {
            margin: 0;
        }
        
        /* Knappar */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-small);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            justify-content: center;
        }
        
        .btn-primary {
            background: var(--color-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--color-primary-dark);
        }
        
        .btn-secondary {
            background: var(--color-bg-alt);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }
        
        .btn-secondary:hover {
            background: var(--color-surface-alt);
        }
        
        .btn-success {
            background: var(--color-success);
            color: white;
        }
        
        .btn-success:hover {
            background: #1b5e20;
        }
        
        .btn-danger {
            background: var(--color-accent);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c62828;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .call-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Stjärnbetyg */
        .star-rating {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .star {
            font-size: 1.5rem;
            color: var(--color-border);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .star.filled {
            color: var(--color-warning);
        }
        
        .star:hover {
            color: var(--color-warning);
        }
        
        /* Toggle switch */
        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--color-border);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .toggle-switch.active {
            background: var(--color-primary);
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        /* Säljmål knappar */
        .sales-section {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .sales-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--color-surface-alt);
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
        }
        
        .sales-info {
            flex: 1;
        }
        
        .sales-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .sales-count {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }
        
        .sales-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .add-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-btn:hover {
            background: var(--color-primary-dark);
            transform: scale(1.05);
        }
        
        /* Progress bars */
        .progress {
            width: 100%;
            height: 8px;
            background: var(--color-border);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--color-success);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        /* Tabell */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-surface);
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        
        .table th {
            background: var(--color-surface-alt);
            font-weight: 600;
            color: var(--color-text);
        }
        
        .table tr:hover {
            background: var(--color-bg-alt);
        }
        
        /* Filter panel */
        .filter-panel {
            background: var(--color-surface-alt);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--color-border);
        }
        
        .filter-row {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        /* Grafcontainer */
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }

        .chart-average-tab {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: var(--color-primary);
            color: #fff;
            border: none;
            border-radius: var(--radius-small);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            box-shadow: var(--shadow-small);
            z-index: 5;
        }

        .chart-average {
            position: absolute;
            top: 2.5rem;
            left: 0.5rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-small);
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            box-shadow: var(--shadow-small);
            display: none;
        }
        
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        /* Toast meddelanden */
        .toast {
            position: fixed;
            top: 100px;
            right: 1rem;
            background: var(--color-success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-small);
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error {
            background: var(--color-accent);
        }
        
        /* Responsiv design */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 0.5rem;
            }
            
            .logo-title {
                gap: 0.5rem;
            }
            
            .title {
                font-size: 1.25rem;
            }
            
            .nav-tabs-content {
                padding: 0 0.5rem;
                overflow-x: auto;
            }
            
            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .main-content {
                padding: 1rem 0.5rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .sales-item {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .sales-actions {
                justify-content: center;
            }
        }
        
        /* Färgtaggar */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .tag-digitala {
            background: rgba(46, 125, 50, 0.1);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }
        
        .tag-tid-utanfor {
            background: rgba(211, 47, 47, 0.1);
            color: var(--color-accent);
            border: 1px solid var(--color-accent);
        }
        
        .tag-kanal {
            background: rgba(11, 92, 171, 0.1);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .tag-guldkund {
            background: rgba(255, 215, 0, 0.1);
            color: #b8860b;
            border: 1px solid #b8860b;
        }
        
        /* Hjälpklasser */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 1rem; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        /* Fokus-stilar för tillgänglighet */
        *:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Header med logo -->
    <header class="header">
        <div class="header-content">
           <div class="logo-title">
             <img src="logo.png" alt="Länsförsäkringar logotyp" class="logo-img">
             <h1 class="title">Kundservice Bank</h1>
        </div>

            <button id="settingsButton" class="icon-button" aria-label="Inställningar">⚙️</button>
        </div>
    </header>

    <!-- Navigation tabs -->
    <nav class="nav-tabs">
        <div class="nav-tabs-content">
            <button class="tab-button active" data-tab="logg" id="tab-logg">Logg</button>
            <button class="tab-button" data-tab="arbetsstod" id="tab-arbetsstod">Arbetsstöd</button>
        </div>
    </nav>

    <main class="main-content">
        <div id="content-logg" class="tab-content active">
            <nav class="subtabs">
                <button class="subtab-button active" data-subtab="samtal" id="subtab-samtal">Samtal</button>
                <button class="subtab-button" data-subtab="saljmal" id="subtab-saljmal">Säljmål</button>
                <button class="subtab-button" data-subtab="statistik" id="subtab-statistik">Statistik</button>
            </nav>
            <!-- Subflik: Samtal -->
            <div id="content-samtal" class="subtab-content active">
            <div class="card">
                <h2 class="card-title">Logga samtal</h2>
                <form id="callForm">
                    <!-- Typ -->
                    <div class="form-group">
                        <label class="form-label">Typ av samtal</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="typ" value="Telefonsamtal" checked>
                                <span>Telefonsamtal</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="typ" value="KF">
                                <span>KF</span>
                            </label>
                        </div>
                    </div>

                    <!-- Kategori (visas bara för Telefonsamtal) -->
                    <div class="form-group" id="kategoriGroup">
                        <label for="kategori" class="form-label">Kategori</label>
                        <select id="kategori" name="kategori" class="form-control">
                            <option value="">Välj kategori...</option>
                            <option value="Guldkund">Guldkund</option>
                            <option value="Bankärende">Bankärende</option>
                        </select>
                    </div>

                    <!-- Stjärnbetyg -->
                    <div class="form-group">
                        <label class="form-label">Upplevelse av samtalet (generellt)</label>
                        <div class="star-rating" data-rating="stjarna_generellt">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                        <input type="hidden" name="stjarna_generellt" id="stjarna_generellt">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Kundens bemötande</label>
                        <div class="star-rating" data-rating="stjarna_kund">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                        <input type="hidden" name="stjarna_kund" id="stjarna_kund">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Min insats</label>
                        <div class="star-rating" data-rating="stjarna_insats">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                        <input type="hidden" name="stjarna_insats" id="stjarna_insats">
                    </div>

                    <!-- Fritextrutor -->
                    <div class="form-group">
                        <label for="beskrivning" class="form-label">Beskriv samtalet</label>
                        <textarea id="beskrivning" name="beskrivning" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="vadGickBra" class="form-label">Vad gick bra?</label>
                        <textarea id="vadGickBra" name="vad_gick_bra" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="forbattra" class="form-label">Vad kan jag göra bättre nästa gång?</label>
                        <textarea id="forbattra" name="forbattra" class="form-control" rows="3"></textarea>
                    </div>

                    <!-- Samtalstid -->
                    <div class="form-group">
                        <label for="samtalstid" class="form-label">Samtalstid (minuter)</label>
                        <input type="number" id="samtalstid" name="samtalstid_min" class="form-control" min="1">
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary">Spara samtal</button>
                        <button type="button" class="btn btn-secondary" id="undoLastCall">Ångra senaste</button>
                        <button type="button" class="btn btn-secondary" id="cancelEdit" style="display:none;">Avbryt</button>
                    </div>
                </form>
            </div>

            <!-- Samtal listor -->
            <div class="card">
                <div class="call-tabs">
                    <button class="call-tab-button active" data-tab="recent">Senaste samtal</button>
                    <button class="call-tab-button" data-tab="all">Alla samtal</button>
                </div>
                <div id="call-recent" class="call-tab-content active">
                    <div class="form-group">
                        <input type="text" id="callSearch" class="form-control" placeholder="Sök i samtal...">
                    </div>
                    <div id="recentCalls"></div>
                </div>
                <div id="call-all" class="call-tab-content">
                    <div class="filter-row">
                        <input type="date" id="filterStartDate" class="form-control">
                        <input type="date" id="filterEndDate" class="form-control">
                        <select id="filterCategory" class="form-control">
                            <option value="">Alla kategorier</option>
                            <option value="Guldkund">Guldkund</option>
                            <option value="Bankärende">Bankärende</option>
                        </select>
                        <select id="filterRating" class="form-control">
                            <option value="">Alla betyg</option>
                            <option value="1">Minst 1</option>
                            <option value="2">Minst 2</option>
                            <option value="3">Minst 3</option>
                            <option value="4">Minst 4</option>
                            <option value="5">Endast 5</option>
                        </select>
                    </div>
                    <div id="allCalls"></div>
                    <button id="loadMoreCalls" class="btn btn-secondary" style="display:none;">Visa mer</button>
                </div>
            </div>
        </div>

        <!-- Subflik: Säljmål -->
        <div id="content-saljmal" class="subtab-content">
            <div class="card">
                <h2 class="card-title">Säljmål - snabb loggning</h2>
                
                <!-- Säkra meddelanden -->
                <div class="sales-item">
                    <div class="sales-info">
                        <div class="sales-title">Säkra meddelanden</div>
                        <div class="sales-count" id="sakraMeddelandenCount">Idag: 0</div>
                        <div class="toggle" id="sakraMeddelandenToggle">
                            <span id="toggleLabel">Tid utanför digitala</span>
                            <div class="toggle-switch" id="digitalToggleSwitch">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                    <div class="sales-actions">
                        <button class="add-btn" id="addSakraMeddelanden" aria-label="Lägg till säkra meddelanden">+</button>
                    </div>
                </div>

                <!-- Informationsfullmakt -->
                <div class="sales-item">
                    <div class="sales-info">
                        <div class="sales-title">Informationsfullmakt</div>
                        <div class="sales-count" id="informationsfullmaktCount">Idag: 0</div>
                    </div>
                    <div class="sales-actions">
                        <button class="add-btn" id="addInformationsfullmakt" aria-label="Lägg till informationsfullmakt">+</button>
                    </div>
                </div>

                <!-- Gula rutan -->
                <div class="sales-item">
                    <div class="sales-info">
                        <div class="sales-title">Gula rutan</div>
                        <div class="sales-count" id="gulaRutanCount">Idag: 0</div>
                    </div>
                    <div class="sales-actions">
                        <button class="add-btn" id="addGulaRutan" aria-label="Lägg till gula rutan">+</button>
                    </div>
                </div>

                <!-- Bolån -->
                <div class="sales-item">
                    <div class="sales-info">
                        <div class="sales-title">Bolån</div>
                        <div class="sales-count" id="bolanCount">Idag: 0</div>
                        <div class="form-group">
                            <select id="bolanKanal" class="form-control">
                                <option value="">Välj kanal...</option>
                                <option value="Säkra meddelanden">Säkra meddelanden</option>
                                <option value="Telefonsamtal inringning">Telefonsamtal inringning</option>
                                <option value="Telefonsamtal utringning">Telefonsamtal utringning</option>
                            </select>
                        </div>
                    </div>
                    <div class="sales-actions">
                        <button class="add-btn" id="addBolan" aria-label="Lägg till bolån">+</button>
                    </div>
                </div>
            </div>

            <!-- Målhantering -->
            <div class="card">
                <h2 class="card-title">Målhantering</h2>
                <div class="form-group">
                    <label for="goalPeriod" class="form-label">Tidsperiod för mål</label>
                    <select id="goalPeriod" class="form-control">
                        <option value="pass">Pass (arbetsdag)</option>
                        <option value="vecka">Vecka</option>
                        <option value="manad">Månad</option>
                        <option value="kvartal">Kvartal</option>
                        <option value="ar">År</option>
                    </select>
                </div>
                <div id="goalSettings"></div>
            </div>
        </div>

        <!-- Subflik: Statistik -->
        <div id="content-statistik" class="subtab-content">
            <!-- Filter panel -->
            <div class="filter-panel">
                <h3 class="mb-2">Filter och inställningar</h3>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="timeRange" class="form-label">Tidsomfång</label>
                        <select id="timeRange" class="form-control">
                            <option value="idag">Idag</option>
                            <option value="vecka">Denna vecka</option>
                            <option value="manad">Denna månad</option>
                            <option value="ar">Detta år</option>
                            <option value="anpassat">Anpassat datumintervall</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="granularity" class="form-label">Granularitet</label>
                        <select id="granularity" class="form-control">
                            <option value="timme">Timme</option>
                            <option value="pass">Pass</option>
                            <option value="dag">Dag</option>
                            <option value="vecka">Vecka</option>
                            <option value="manad">Månad</option>
                            <option value="kvartal">Kvartal</option>
                            <option value="ar">År</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sakraFilter" class="form-label">Säkra meddelanden</label>
                        <select id="sakraFilter" class="form-control">
                            <option value="alla">Alla</option>
                            <option value="digitala">Digitala</option>
                            <option value="tid-utanfor">Tid utanför digitala</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bolanFilter" class="form-label">Bolån kanal</label>
                        <select id="bolanFilter" class="form-control">
                            <option value="alla">Alla kanaler</option>
                            <option value="Säkra meddelanden">Säkra meddelanden</option>
                            <option value="Telefonsamtal inringning">Telefonsamtal inringning</option>
                            <option value="Telefonsamtal utringning">Telefonsamtal utringning</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label class="form-label">Data att visa</label>
                        <div id="typeFilters" class="checkbox-group">
                            <label><input type="checkbox" class="type-filter" value="samtal" checked> Samtal</label>
                            <label><input type="checkbox" class="type-filter" value="Guldkund" checked> Guldkundssamtal</label>
                            <label><input type="checkbox" class="type-filter" value="Bankärende" checked> Bankärende samtal</label>
                            <label><input type="checkbox" class="type-filter" value="Säkra meddelanden" checked> Säkra meddelanden</label>
                            <label><input type="checkbox" class="type-filter" value="Informationsfullmakt" checked> Informationsfullmakt</label>
                            <label><input type="checkbox" class="type-filter" value="Gula rutan" checked> Gula rutan</label>
                            <label><input type="checkbox" class="type-filter" value="Bolån" checked> Bolån</label>
                            <label><input type="checkbox" class="type-filter" value="totalt" checked> Ärenden totalt</label>
                        </div>
                    </div>
                </div>
                <div class="filter-row" id="customDateRange" style="display: none;">
                    <div class="form-group">
                        <label for="startDate" class="form-label">Startdatum</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="endDate" class="form-label">Slutdatum</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>
            </div>

            <!-- Målprogress -->
            <div class="card">
                <h2 class="card-title">Målprogress</h2>
                <div id="goalProgress"></div>
            </div>

            <!-- Grafer -->
            <div class="card">
                <div class="chart-controls">
                    <h2 class="card-title">Statistikgrafer</h2>
                    <div class="flex gap-1">
                        <button class="btn btn-secondary" id="chartTypeLine">Linje</button>
                        <button class="btn btn-secondary" id="chartTypeBar">Kolumn</button>
                    </div>
                </div>
                <div class="chart-container">
                    <button id="averageToggle" class="chart-average-tab" aria-label="Visa genomsnitt">📊</button>
                    <div id="averageBox" class="chart-average" data-open="false"></div>
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Tabellvy -->
            <div class="card">
                <div class="chart-controls">
                    <h2 class="card-title">Tabelldata</h2>
                    <button class="btn btn-secondary" id="exportTable">Exportera tabell</button>
                </div>
                <div class="table-container">
                    <table class="table" id="statsTable">
                        <thead id="statsTableHead"></thead>
                        <tbody id="statsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Import/Export -->
            <div class="card">
                <h2 class="card-title">Data hantering</h2>
                <div class="flex gap-2">
                    <button class="btn btn-primary" id="exportData">Exportera all data</button>
                    <label class="btn btn-secondary">
                        Importera data
                        <input type="file" id="importData" accept=".json,.csv" style="display: none;">
                    </label>
                </div>
            </div>
        </div>
        </div>

        <div id="content-arbetsstod" class="tab-content">
            <nav class="subtabs">
                <button class="subtab-button active" data-subtab="skriv-arende" id="tab-skriv-arende">Skriv ärende</button>
            </nav>
            <div id="panel-skriv-arende" class="subtab-content active">
                <div class="card">
                    <h2 class="card-title">Skriv ärende</h2>
                    <form id="caseWizardForm">
                        <div class="form-group">
                            <label class="form-label">1. Vad avser ärendet?</label>
                            <div class="radio-group">
                                <label class="radio-item"><input type="radio" name="caseType" value="swish" checked><span>Swishhöjning</span></label>
                                <label class="radio-item"><input type="radio" name="caseType" value="overforing"><span>Överföring</span></label>
                                <label class="radio-item"><input type="radio" name="caseType" value="betalning"><span>Betalning</span></label>
                                <label class="radio-item"><input type="radio" name="caseType" value="utlands"><span>Utlandsbetalning</span></label>
                                <label class="radio-item"><input type="radio" name="caseType" value="fritext"><span>Fritext</span></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">2. Handling och belopp</label>
                            <select id="handling" class="form-control">
                                <option value="kop">göra ett köp</option>
                                <option value="overfora">överföra</option>
                                <option value="betala">betala</option>
                                <option value="utlandsbetalning">göra en utlandsbetalning</option>
                                <option value="fritext">fritext</option>
                            </select>
                            <input type="text" id="handlingFritext" class="form-control" placeholder="Fritext" style="display:none; margin-top:0.5rem;">
                            <input type="number" id="summa" class="form-control" placeholder="Belopp i tkr" min="0" style="margin-top:0.5rem;">
                            <input type="text" id="summaUtland" class="form-control" placeholder="Belopp och valuta" style="display:none; margin-top:0.5rem;">
                            <input type="text" id="utlandsLand" class="form-control" placeholder="Land" style="display:none; margin-top:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label for="avseende" class="form-label">Avseende</label>
                            <select id="avseende" class="form-control">
                                <option value="">Välj...</option>
                                <option value="bilkop">Bilköp</option>
                                <option value="sparande">Sparande i annat institut</option>
                                <option value="fritext">Fritext</option>
                            </select>
                            <select id="avseendeBilkop" class="form-control" style="display:none; margin-top:0.5rem;">
                                <option value="från privatperson">från privatperson</option>
                                <option value="från bilhandlare">från bilhandlare</option>
                            </select>
                            <select id="avseendeSpar" class="form-control" style="display:none; margin-top:0.5rem;">
                                <option value="Avanza">Avanza</option>
                                <option value="Nordnet">Nordnet</option>
                                <option value="Fritext">Fritext</option>
                            </select>
                            <input id="avseendeFritext" class="form-control" placeholder="Fritext" style="display:none; margin-top:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label for="ursprung" class="form-label">3. Finansieringens ursprung</label>
                            <select id="ursprung" class="form-control">
                                <option value="lon">Eget sparande av lön</option>
                                <option value="lan">Lån</option>
                                <option value="annat">Eget sparande i annat institut</option>
                                <option value="fritext">Fritext</option>
                            </select>
                            <select id="ursprungLanDetalj" class="form-control" style="display:none; margin-top:0.5rem;">
                                <option value="skuldebrev">skuldebrev inskickat som underlag</option>
                                <option value="inget">finns inget skuldebrev</option>
                            </select>
                            <label id="annatUnderlagLabel" style="display:none; margin-top:0.5rem;">
                                <input type="checkbox" id="annatUnderlag"> underlag inskickat
                            </label>
                            <input id="ursprungFritext" class="form-control" placeholder="Fritext" style="display:none; margin-top:0.5rem;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">4. KYC</label>
                            <textarea id="kycText" class="form-control" rows="2" readonly></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">5. Avtal</label>
                            <textarea id="avtalText" class="form-control" rows="2" readonly></textarea>
                        </div>
                        <button type="button" id="generateCase" class="btn btn-primary">Generera</button>
                    </form>
                    <div class="form-group">
                        <label for="caseOutput" class="form-label">Ärende</label>
                        <textarea id="caseOutput" class="form-control" rows="12"></textarea>
                        <button type="button" id="copyCaseBtn" class="btn btn-secondary" style="margin-top:0.5rem;">Kopiera</button>
                    </div>
                    <div class="form-group">
                        <label for="activityOutput" class="form-label">Aktivitet</label>
                        <textarea id="activityOutput" class="form-control" rows="4"></textarea>
                        <button type="button" id="copyActivityBtn" class="btn btn-secondary" style="margin-top:0.5rem;">Kopiera</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flik: Inställningar -->
        <div id="content-installningar" class="tab-content">
            <!-- Utseende -->
            <div class="card">
                <h2 class="card-title">Utseende</h2>
                <button class="theme-toggle" id="themeToggle" aria-label="Växla mellan ljust och mörkt tema">🌙</button>
            </div>

            <!-- Exempeldata -->
            <div class="card">
                <h2 class="card-title">Exempeldata</h2>
                <p class="mb-2">Populera applikationen med realistisk testdata för demonstration.</p>
                <button class="btn btn-success" id="populateExampleData">
                    📊 Populera med exempeldata
                </button>
            </div>

            <!-- Datahantering -->
            <div class="card">
                <h2 class="card-title">⚠️ Radera all data</h2>
                <p class="mb-2" style="color: var(--color-accent);">
                    <strong>Varning:</strong> Detta kommer permanent radera all sparad data (samtal, säljmål, statistik och mål).
                    Denna åtgärd kan inte ångras.
                </p>
                
                <div class="form-group">
                    <label for="confirmDelete" class="form-label">
                        Skriv "RADERA" för att bekräfta borttagning:
                    </label>
                    <input 
                        type="text" 
                        id="confirmDelete" 
                        class="form-control" 
                        placeholder="Skriv RADERA här..."
                        autocomplete="off"
                    >
                </div>
                
                <button class="btn btn-danger" id="deleteAllData" disabled>
                    🗑️ Radera all data permanent
                </button>
            </div>

        </div>
    </main>

    <!-- Toast container -->
    <div id="toastContainer"></div>

    <script type="module">
        // ====================
        // GLOBALA VARIABLER OCH KONFIGURATION
        // ====================
        
        let currentTab = 'logg';
        let currentLoggTab = 'samtal';
        let currentChart = null;
        let digitalToggleState = false; // false = "Tid utanför digitala", true = "Digitala"
        let editingCallId = null;
        let allCallsPage = 1;
        
        // Standardmål per pass (arbetsdag)
        const DEFAULT_GOALS = {
            pass: {
                'Säkra meddelanden': 20,
                'Informationsfullmakt': 2,
                'Gula rutan': 5,
                'Bolån': 1
            },
            vecka: {
                'Säkra meddelanden': 100,
                'Informationsfullmakt': 10,
                'Gula rutan': 25,
                'Bolån': 5
            },
            manad: {
                'Säkra meddelanden': 400,
                'Informationsfullmakt': 40,
                'Gula rutan': 100,
                'Bolån': 20
            },
            kvartal: {
                'Säkra meddelanden': 1200,
                'Informationsfullmakt': 120,
                'Gula rutan': 300,
                'Bolån': 60
            },
            ar: {
                'Säkra meddelanden': 4800,
                'Informationsfullmakt': 480,
                'Gula rutan': 1200,
                'Bolån': 240
            }
        };
        
        // ====================
        // HJÄLPFUNKTIONER FÖR DATAHANTERING
        // ====================
        
        // Generera UUID för unika ID:n
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // IndexedDB-konfiguration
        const DB_NAME = 'ksDB';
        const STORE_NAME = 'ksStore';
        let db;
        const dbCache = {};

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    const transaction = db.transaction(STORE_NAME, 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const cursorRequest = store.openCursor();
                    cursorRequest.onsuccess = (e) => {
                        const cursor = e.target.result;
                        if (cursor) {
                            dbCache[cursor.key] = cursor.value;
                            cursor.continue();
                        } else {
                            resolve();
                        }
                    };
                    cursorRequest.onerror = () => resolve();
                };

                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // Hämta data från IndexedDB-cache med fallback till defaultValue
        function getLocalStorage(key, defaultValue = null) {
            return dbCache.hasOwnProperty(key) ? dbCache[key] : defaultValue;
        }

        // Spara data till IndexedDB
        function setLocalStorage(key, data) {
            dbCache[key] = data;
            try {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).put(data, key);
            } catch (error) {
                console.error(`Fel vid sparning av ${key}:`, error);
                showToast('Fel vid sparning av data', 'error');
            }
        }

        // Ta bort data från IndexedDB
        function removeLocalStorage(key) {
            delete dbCache[key];
            try {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).delete(key);
            } catch (error) {
                console.error(`Fel vid radering av ${key}:`, error);
            }
        }
        
        // Formatera datum och tid
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return {
                date: date.toLocaleDateString('sv-SE'),
                time: date.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' }),
                full: date.toLocaleString('sv-SE')
            };
        }
        
        // Visa toast-meddelanden
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            const container = document.getElementById('toastContainer');
            container.appendChild(toast);
            
            // Visa toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Ta bort toast efter 3 sekunder
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }
        
        // ====================
        // TEMA-HANTERING
        // ====================
        
        function initTheme() {
            const savedTheme = getLocalStorage('ksTheme');
            const themeToggle = document.getElementById('themeToggle');
            
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);
            }
            
            themeToggle.addEventListener('click', toggleTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            setLocalStorage('ksTheme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        function updateThemeIcon(theme) {
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
        }
        
        // ====================
        // FLIK-NAVIGATION
        // ====================
        
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            function activateTab(tabId) {
                tabButtons.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));

                const btn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
                if (btn) btn.classList.add('active');

                const content = document.getElementById(`content-${tabId}`);
                if (content) content.classList.add('active');

                currentTab = tabId;

                if (tabId === 'logg') {
                    if (currentLoggTab === 'samtal') {
                        updateRecentCalls();
                        updateAllCalls();
                    } else if (currentLoggTab === 'saljmal') {
                        updateSalesCounters();
                    } else if (currentLoggTab === 'statistik') {
                        updateStatistics();
                    }
                }
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => activateTab(button.dataset.tab));
            });

            document.getElementById('settingsButton').addEventListener('click', () => activateTab('installningar'));

            activateTab('logg');
            window.activateTab = activateTab;
        }

        function initLoggTabs() {
            const buttons = document.querySelectorAll('#content-logg .subtab-button');
            const contents = document.querySelectorAll('#content-logg .subtab-content');

            function activate(id) {
                buttons.forEach(b => b.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                document.querySelector(`#content-logg .subtab-button[data-subtab="${id}"]`).classList.add('active');
                document.getElementById(`content-${id}`).classList.add('active');
                currentLoggTab = id;

                if (id === 'samtal') {
                    updateRecentCalls();
                    updateAllCalls();
                } else if (id === 'saljmal') {
                    updateSalesCounters();
                } else if (id === 'statistik') {
                    updateStatistics();
                }
            }

            buttons.forEach(b => b.addEventListener('click', () => activate(b.dataset.subtab)));
            activate('samtal');
        }

        function initCallTabs() {
            const buttons = document.querySelectorAll('.call-tab-button');
            const contents = document.querySelectorAll('.call-tab-content');

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const target = button.dataset.tab;
                    buttons.forEach(b => b.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(`call-${target}`).classList.add('active');
                    if (target === 'recent') {
                        updateRecentCalls();
                    } else {
                        allCallsPage = 1;
                        updateAllCalls();
                    }
                });
            });

            document.getElementById('loadMoreCalls').addEventListener('click', () => {
                allCallsPage++;
                updateAllCalls();
            });

            ['filterStartDate','filterEndDate','filterCategory','filterRating'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('change', () => {
                    allCallsPage = 1;
                    updateAllCalls();
                });
            });

            updateAllCalls();
        }
        
        // ====================
        // STJÄRNBETYG-HANTERING
        // ====================
        
        function initStarRatings() {
            const starRatings = document.querySelectorAll('.star-rating');
            
            starRatings.forEach(rating => {
                const stars = rating.querySelectorAll('.star');
                const ratingName = rating.getAttribute('data-rating');
                const hiddenInput = document.getElementById(ratingName);
                
                stars.forEach((star, index) => {
                    star.addEventListener('click', () => {
                        const value = index + 1;
                        hiddenInput.value = value;
                        updateStars(stars, value);
                    });
                    
                    star.addEventListener('mouseover', () => {
                        updateStars(stars, index + 1, true);
                    });
                });
                
                rating.addEventListener('mouseleave', () => {
                    const currentValue = parseInt(hiddenInput.value) || 0;
                    updateStars(stars, currentValue);
                });
            });
        }
        
        function updateStars(stars, value, isHover = false) {
            stars.forEach((star, index) => {
                if (index < value) {
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                }
            });
        }

        function setStarRating(ratingName, value) {
            const rating = document.querySelector(`.star-rating[data-rating="${ratingName}"]`);
            if (!rating) return;
            const stars = rating.querySelectorAll('.star');
            const hiddenInput = document.getElementById(ratingName);
            hiddenInput.value = value || '';
            updateStars(stars, value || 0);
        }

        // ====================
        // SAMTAL-HANTERING
        // ====================
        
        function initCallForm() {
            const callForm = document.getElementById('callForm');
            const typInputs = document.querySelectorAll('input[name="typ"]');
            const kategoriGroup = document.getElementById('kategoriGroup');
            const undoButton = document.getElementById('undoLastCall');
            const cancelEditButton = document.getElementById('cancelEdit');
            const searchInput = document.getElementById('callSearch');
            
            // Visa/dölj kategori beroende på typ
            typInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    if (e.target.value === 'Telefonsamtal') {
                        kategoriGroup.style.display = 'block';
                    } else {
                        kategoriGroup.style.display = 'none';
                        document.getElementById('kategori').value = '';
                    }
                });
            });
            
            // Hantera formulärinlämning
            callForm.addEventListener('submit', handleCallSubmit);

            // Ångra senaste samtal
            undoButton.addEventListener('click', undoLastCall);

            // Avbryt redigering
            cancelEditButton.addEventListener('click', cancelEditCall);

            // Sök i samtal
            searchInput.addEventListener('input', updateRecentCalls);

            // Initial uppdatering
            updateRecentCalls();
            updateAllCalls();
        }
        
        function handleCallSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const callData = {
                typ: formData.get('typ'),
                kategori: formData.get('kategori') || null,
                stjarna_generellt: parseInt(formData.get('stjarna_generellt')) || null,
                stjarna_kund: parseInt(formData.get('stjarna_kund')) || null,
                stjarna_insats: parseInt(formData.get('stjarna_insats')) || null,
                beskrivning: formData.get('beskrivning') || '',
                vad_gick_bra: formData.get('vad_gick_bra') || '',
                forbattra: formData.get('forbattra') || '',
                samtalstid_min: formData.get('samtalstid_min') ? parseInt(formData.get('samtalstid_min')) : null
            };
            
            // Validering
            if (!callData.stjarna_generellt || !callData.stjarna_kund || !callData.stjarna_insats) {
                showToast('Alla stjärnbetyg måste sättas', 'error');
                return;
            }
            
            if (callData.typ === 'Telefonsamtal' && !callData.kategori) {
                showToast('Kategori måste väljas för telefonsamtal', 'error');
                return;
            }
            
            // Spara eller uppdatera samtal
            const calls = getLocalStorage('ksCalls', []);

            if (editingCallId) {
                const index = calls.findIndex(c => c.id === editingCallId);
                if (index !== -1) {
                    callData.id = editingCallId;
                    callData.timestamp = calls[index].timestamp;
                    calls[index] = callData;
                    setLocalStorage('ksCalls', calls);
                    showToast('Samtalet har uppdaterats');
                }
                editingCallId = null;
                document.querySelector('#callForm button[type="submit"]').textContent = 'Spara samtal';
                document.getElementById('cancelEdit').style.display = 'none';
            } else {
                callData.id = generateUUID();
                callData.timestamp = new Date().toISOString();
                calls.push(callData);
                setLocalStorage('ksCalls', calls);
                showToast('Samtalet har sparats');
            }
            
            // Återställ formulär
            e.target.reset();
            resetStarRatings();
            
            // Uppdatera lista
            updateRecentCalls();
            allCallsPage = 1;
            updateAllCalls();
            
            // Uppdatera räknare om vi är på säljmål-fliken
            if (currentTab === 'logg' && currentLoggTab === 'saljmal') {
                updateSalesCounters();
            }
        }
        
        function resetStarRatings() {
            const hiddenInputs = document.querySelectorAll('input[type="hidden"][id^="stjarna_"]');
            hiddenInputs.forEach(input => {
                input.value = '';
            });
            
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => star.classList.remove('filled'));
        }
        
        function undoLastCall() {
            const calls = getLocalStorage('ksCalls', []);
            if (calls.length === 0) {
                showToast('Inga samtal att ångra', 'error');
                return;
            }
            
            calls.pop();
            setLocalStorage('ksCalls', calls);
            showToast('Senaste samtalet har tagits bort');
            updateRecentCalls();
            allCallsPage = 1;
            updateAllCalls();

            if (currentTab === 'logg' && currentLoggTab === 'saljmal') {
                updateSalesCounters();
            }
        }

        function startEditCall(id) {
            const calls = getLocalStorage('ksCalls', []);
            const call = calls.find(c => c.id === id);
            if (!call) return;

            editingCallId = id;

            const typInput = document.querySelector(`input[name="typ"][value="${call.typ}"]`);
            if (typInput) {
                typInput.checked = true;
                typInput.dispatchEvent(new Event('change'));
            }
            document.getElementById('kategori').value = call.kategori || '';
            setStarRating('stjarna_generellt', call.stjarna_generellt);
            setStarRating('stjarna_kund', call.stjarna_kund);
            setStarRating('stjarna_insats', call.stjarna_insats);
            document.getElementById('beskrivning').value = call.beskrivning || '';
            document.getElementById('vadGickBra').value = call.vad_gick_bra;
            document.getElementById('forbattra').value = call.forbattra;
            document.getElementById('samtalstid').value = call.samtalstid_min || '';

            document.querySelector('#callForm button[type="submit"]').textContent = 'Uppdatera samtal';
            document.getElementById('cancelEdit').style.display = 'inline-flex';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEditCall() {
            editingCallId = null;
            document.getElementById('callForm').reset();
            resetStarRatings();
            document.querySelector('#callForm button[type="submit"]').textContent = 'Spara samtal';
            document.getElementById('cancelEdit').style.display = 'none';
        }

        function deleteCall(id) {
            if (!confirm('Är du säker på att du vill ta bort detta samtal?')) return;
            const calls = getLocalStorage('ksCalls', []);
            const index = calls.findIndex(c => c.id === id);
            if (index !== -1) {
                calls.splice(index, 1);
                setLocalStorage('ksCalls', calls);
                showToast('Samtalet har tagits bort');
                if (editingCallId === id) {
                    cancelEditCall();
                }
                updateRecentCalls();
                allCallsPage = 1;
                updateAllCalls();
                if (currentTab === 'logg' && currentLoggTab === 'saljmal') {
                    updateSalesCounters();
                }
            }
        }

        function renderCall(call) {
            const dateTime = formatDateTime(call.timestamp);
            const stars = (rating) => '★'.repeat(rating || 0) + '☆'.repeat(5 - (rating || 0));

            return `
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${call.typ}</strong>
                            ${call.kategori ? `<span class="tag ${call.kategori === 'Guldkund' ? 'tag-guldkund' : 'tag-kanal'}">${call.kategori}</span>` : ''}
                        </div>
                        <small style="color: var(--color-text-muted);">${dateTime.full}</small>
                    </div>
                    <div class="grid-2" style="margin-bottom: 0.5rem;">
                        <div><small>Generellt: ${stars(call.stjarna_generellt)}</small></div>
                        <div><small>Kund: ${stars(call.stjarna_kund)}</small></div>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <small>Min insats: ${stars(call.stjarna_insats)}</small>
                        ${call.samtalstid_min ? `<small style="float: right;">${call.samtalstid_min} min</small>` : ''}
                    </div>
                    ${call.beskrivning ? `<div style="margin-bottom: 0.25rem;"><small><strong>Beskrivning:</strong> ${call.beskrivning}</small></div>` : ''}
                    ${call.vad_gick_bra ? `<div style="margin-bottom: 0.25rem;"><small><strong>Bra:</strong> ${call.vad_gick_bra}</small></div>` : ''}
                    ${call.forbattra ? `<div><small><strong>Förbättra:</strong> ${call.forbattra}</small></div>` : ''}
                    <div class="call-actions">
                        <button class="btn btn-secondary btn-small edit-call" data-id="${call.id}">Ändra</button>
                        <button class="btn btn-danger btn-small delete-call" data-id="${call.id}">Ta bort</button>
                    </div>
                </div>
            `;
        }

        function updateRecentCalls() {
            const calls = getLocalStorage('ksCalls', []);
            const searchTerm = document.getElementById('callSearch').value.toLowerCase();
            const container = document.getElementById('recentCalls');
            
            // Filtrera och sortera samtal
            const filteredCalls = calls
                .filter(call => {
                    if (!searchTerm) return true;
                    return (call.beskrivning && call.beskrivning.toLowerCase().includes(searchTerm)) ||
                           call.vad_gick_bra.toLowerCase().includes(searchTerm) ||
                           call.forbattra.toLowerCase().includes(searchTerm) ||
                           call.typ.toLowerCase().includes(searchTerm) ||
                           (call.kategori && call.kategori.toLowerCase().includes(searchTerm));
                })
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10); // Visa bara de 10 senaste
            
            if (filteredCalls.length === 0) {
                container.innerHTML = '<p class="text-center">Inga samtal hittades.</p>';
                return;
            }
            
            const html = filteredCalls.map(renderCall).join('');

            container.innerHTML = html;

            container.querySelectorAll('.edit-call').forEach(btn => {
                btn.addEventListener('click', () => startEditCall(btn.dataset.id));
            });
            container.querySelectorAll('.delete-call').forEach(btn => {
                btn.addEventListener('click', () => deleteCall(btn.dataset.id));
            });
        }

        function updateAllCalls() {
            const calls = getLocalStorage('ksCalls', []);
            const container = document.getElementById('allCalls');

            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const category = document.getElementById('filterCategory').value;
            const rating = document.getElementById('filterRating').value;

            let filtered = [...calls];

            if (startDate) {
                const start = new Date(startDate);
                filtered = filtered.filter(c => new Date(c.timestamp) >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23,59,59,999);
                filtered = filtered.filter(c => new Date(c.timestamp) <= end);
            }
            if (category) {
                filtered = filtered.filter(c => c.kategori === category);
            }
            if (rating) {
                const r = parseInt(rating);
                filtered = filtered.filter(c => (c.stjarna_generellt || 0) >= r);
            }

            filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            const endIndex = allCallsPage * 10;
            const pageCalls = filtered.slice(0, endIndex);

            if (pageCalls.length === 0) {
                container.innerHTML = '<p class="text-center">Inga samtal hittades.</p>';
            } else {
                container.innerHTML = pageCalls.map(renderCall).join('');
                container.querySelectorAll('.edit-call').forEach(btn => {
                    btn.addEventListener('click', () => startEditCall(btn.dataset.id));
                });
                container.querySelectorAll('.delete-call').forEach(btn => {
                    btn.addEventListener('click', () => deleteCall(btn.dataset.id));
                });
            }

            const moreBtn = document.getElementById('loadMoreCalls');
            if (filtered.length > endIndex) {
                moreBtn.style.display = 'block';
            } else {
                moreBtn.style.display = 'none';
            }
        }
        
        // ====================
        // SÄLJMÅL-HANTERING
        // ====================
        
        function initSalesGoals() {
            // Digital toggle för säkra meddelanden
            const digitalToggle = document.getElementById('digitalToggleSwitch');
            const toggleLabel = document.getElementById('toggleLabel');
            
            digitalToggle.addEventListener('click', () => {
                digitalToggleState = !digitalToggleState;
                digitalToggle.classList.toggle('active', digitalToggleState);
                toggleLabel.textContent = digitalToggleState ? 'Digitala' : 'Tid utanför digitala';
            });
            
            // Lägg till-knappar
            document.getElementById('addSakraMeddelanden').addEventListener('click', () => {
                addSalesEntry('Säkra meddelanden', digitalToggleState ? 'Digitala' : 'Tid utanför digitala');
            });
            
            document.getElementById('addInformationsfullmakt').addEventListener('click', () => {
                addSalesEntry('Informationsfullmakt');
            });
            
            document.getElementById('addGulaRutan').addEventListener('click', () => {
                addSalesEntry('Gula rutan');
            });
            
            document.getElementById('addBolan').addEventListener('click', () => {
                const kanal = document.getElementById('bolanKanal').value;
                if (!kanal) {
                    showToast('Välj kanal för bolån', 'error');
                    return;
                }
                addSalesEntry('Bolån', null, kanal);
                document.getElementById('bolanKanal').value = '';
            });
            
            // Målhantering
            const goalPeriod = document.getElementById('goalPeriod');
            goalPeriod.addEventListener('change', updateGoalSettings);
            
            // Initial uppdatering
            updateSalesCounters();
            updateGoalSettings();
        }
        
        function addSalesEntry(typ, tagg = null, kanal = null) {
            const salesEntry = {
                id: generateUUID(),
                typ: typ,
                tagg: tagg,
                kanal: kanal,
                timestamp: new Date().toISOString()
            };
            
            const sales = getLocalStorage('ksSales', []);
            sales.push(salesEntry);
            setLocalStorage('ksSales', sales);
            
            showToast(`${typ} har loggats`);
            updateSalesCounters();
        }
        
        function updateSalesCounters() {
            const sales = getLocalStorage('ksSales', []);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayISO = today.toISOString();
            
            // Filtrera dagens försäljning
            const todaySales = sales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                saleDate.setHours(0, 0, 0, 0);
                return saleDate.toISOString() === todayISO;
            });
            
            // Räkna varje typ
            const counts = {
                'Säkra meddelanden': todaySales.filter(s => s.typ === 'Säkra meddelanden').length,
                'Informationsfullmakt': todaySales.filter(s => s.typ === 'Informationsfullmakt').length,
                'Gula rutan': todaySales.filter(s => s.typ === 'Gula rutan').length,
                'Bolån': todaySales.filter(s => s.typ === 'Bolån').length
            };
            
            // Uppdatera UI
            document.getElementById('sakraMeddelandenCount').textContent = `Idag: ${counts['Säkra meddelanden']}`;
            document.getElementById('informationsfullmaktCount').textContent = `Idag: ${counts['Informationsfullmakt']}`;
            document.getElementById('gulaRutanCount').textContent = `Idag: ${counts['Gula rutan']}`;
            document.getElementById('bolanCount').textContent = `Idag: ${counts['Bolån']}`;
        }
        
        function updateGoalSettings() {
            const period = document.getElementById('goalPeriod').value;
            const container = document.getElementById('goalSettings');
            const goals = getLocalStorage('ksGoals', DEFAULT_GOALS);
            
            if (!goals[period]) {
                goals[period] = {...DEFAULT_GOALS[period]};
                setLocalStorage('ksGoals', goals);
            }
            
            const goalTypes = ['Säkra meddelanden', 'Informationsfullmakt', 'Gula rutan', 'Bolån'];
            
            const html = goalTypes.map(type => {
                const currentGoal = goals[period][type] || DEFAULT_GOALS[period][type];
                return `
                    <div class="form-group">
                        <label for="goal-${type}" class="form-label">${type}</label>
                        <input 
                            type="number" 
                            id="goal-${type}" 
                            class="form-control" 
                            value="${currentGoal}"
                            min="0"
                            data-type="${type}"
                            data-period="${period}"
                        >
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // Lägg till event listeners för måluppdateringar
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const type = e.target.getAttribute('data-type');
                    const period = e.target.getAttribute('data-period');
                    const value = parseInt(e.target.value) || 0;
                    
                    const goals = getLocalStorage('ksGoals', DEFAULT_GOALS);
                    if (!goals[period]) goals[period] = {};
                    goals[period][type] = value;
                    setLocalStorage('ksGoals', goals);
                    
                    showToast(`Mål för ${type} uppdaterat`);
                });
            });
        }
        
        // ====================
        // STATISTIK-HANTERING
        // ====================
        
        function initStatistics() {
            const timeRangeSelect = document.getElementById('timeRange');
            const customDateRange = document.getElementById('customDateRange');
            const chartTypeButtons = document.querySelectorAll('#chartTypeLine, #chartTypeBar');
            const exportButton = document.getElementById('exportTable');
            const avgToggle = document.getElementById('averageToggle');
            const avgBox = document.getElementById('averageBox');
            
            // Visa/dölj anpassat datumintervall
            timeRangeSelect.addEventListener('change', (e) => {
                if (e.target.value === 'anpassat') {
                    customDateRange.style.display = 'grid';
                } else {
                    customDateRange.style.display = 'none';
                }
                updateStatistics();
            });
            
            // Lyssna på alla filter-ändringar för reaktiv uppdatering
            ['granularity', 'sakraFilter', 'bolanFilter', 'startDate', 'endDate'].forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('change', () => {
                    // Lägg till visual feedback
                    element.style.transform = 'scale(1.02)';
                    setTimeout(() => element.style.transform = 'scale(1)', 150);
                    updateStatistics();
                });
            });

            // Typfilter
            document.querySelectorAll('.type-filter').forEach(cb => {
                cb.addEventListener('change', updateStatistics);
            });
            
            // Diagram-typ knappar
            chartTypeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    chartTypeButtons.forEach(b => b.classList.remove('btn-primary'));
                    chartTypeButtons.forEach(b => b.classList.add('btn-secondary'));
                    e.target.classList.remove('btn-secondary');
                    e.target.classList.add('btn-primary');
                    updateChart();
                });
            });

            // Genomsnittsruta toggle
            avgToggle.addEventListener('click', () => {
                const isOpen = avgBox.dataset.open === 'true';
                avgBox.dataset.open = (!isOpen).toString();
                if (avgBox.dataset.open === 'true' && avgBox.innerHTML.trim() !== '') {
                    avgBox.style.display = 'block';
                } else {
                    avgBox.style.display = 'none';
                }
            });
            
            // Export tabell
            exportButton.addEventListener('click', exportTableData);
            
            // Sätt standardvärden
            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
            
            // Initial uppdatering
            updateStatistics();
        }
        
        function updateStatistics() {
            updateGoalProgress();
            updateChart();
            updateTable();
        }
        
        function getDateRange() {
            const timeRange = document.getElementById('timeRange').value;
            const today = new Date();
            let startDate, endDate;
            
            switch (timeRange) {
                case 'idag':
                    startDate = new Date(today);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'vecka':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay() + 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'manad':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59, 999);
                    break;
                case 'ar':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31, 23, 59, 59, 999);
                    break;
                case 'anpassat':
                    const startInput = document.getElementById('startDate').value;
                    const endInput = document.getElementById('endDate').value;
                    if (!startInput || !endInput) return null;
                    startDate = new Date(startInput);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(endInput);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                default:
                    return null;
            }
            
            return { startDate, endDate };
        }
        
        function filterData() {
            const dateRange = getDateRange();
            if (!dateRange) return { calls: [], sales: [], allSales: [] };

            const { startDate, endDate } = dateRange;
            const calls = getLocalStorage('ksCalls', []);
            const sales = getLocalStorage('ksSales', []);

            // Filtrera samtal
            const filteredCalls = calls.filter(call => {
                const callDate = new Date(call.timestamp);
                return callDate >= startDate && callDate <= endDate;
            });

            // Filtrera försäljning (datumintervall)
            const salesInRange = sales.filter(sale => {
                const saleDate = new Date(sale.timestamp);
                return saleDate >= startDate && saleDate <= endDate;
            });

            // Applicera övriga filter på försäljning
            let filteredSales = salesInRange;

            // Applicera säkra meddelanden filter
            const sakraFilter = document.getElementById('sakraFilter').value;
            if (sakraFilter !== 'alla') {
                filteredSales = filteredSales.filter(sale => {
                    if (sale.typ !== 'Säkra meddelanden') return true;
                    return sakraFilter === 'digitala' ?
                        sale.tagg === 'Digitala' :
                        sale.tagg === 'Tid utanför digitala';
                });
            }

            // Applicera bolån filter
            const bolanFilter = document.getElementById('bolanFilter').value;
            if (bolanFilter !== 'alla') {
                filteredSales = filteredSales.filter(sale => {
                    if (sale.typ !== 'Bolån') return true;
                    return sale.kanal === bolanFilter;
                });
            }

            return { calls: filteredCalls, sales: filteredSales, allSales: salesInRange };
        }
        
        function updateGoalProgress() {
            const { sales } = filterData();
            
            // Bestäm målperiod baserat på valt tidsomfång i statistikfliken
            const timeRange = document.getElementById('timeRange').value;
            let goalPeriod;
            switch (timeRange) {
                case 'idag':
                    goalPeriod = 'pass';
                    break;
                case 'vecka':
                    goalPeriod = 'vecka';
                    break;
                case 'manad':
                    goalPeriod = 'manad';
                    break;
                case 'ar':
                    goalPeriod = 'ar';
                    break;
                case 'anpassat':
                    // För anpassat datumintervall, beräkna längd och välj lämplig period
                    const dateRange = getDateRange();
                    if (dateRange) {
                        const days = Math.ceil((dateRange.endDate - dateRange.startDate) / (1000 * 60 * 60 * 24));
                        if (days <= 1) goalPeriod = 'pass';
                        else if (days <= 7) goalPeriod = 'vecka';
                        else if (days <= 31) goalPeriod = 'manad';
                        else if (days <= 90) goalPeriod = 'kvartal';
                        else goalPeriod = 'ar';
                    } else {
                        goalPeriod = 'pass';
                    }
                    break;
                default:
                    goalPeriod = 'pass';
            }
            
            const goals = getLocalStorage('ksGoals', DEFAULT_GOALS);
            const currentGoals = goals[goalPeriod] || DEFAULT_GOALS[goalPeriod];
            
            // Räkna aktuell försäljning
            const counts = {
                'Säkra meddelanden': sales.filter(s => s.typ === 'Säkra meddelanden').length,
                'Informationsfullmakt': sales.filter(s => s.typ === 'Informationsfullmakt').length,
                'Gula rutan': sales.filter(s => s.typ === 'Gula rutan').length,
                'Bolån': sales.filter(s => s.typ === 'Bolån').length
            };
            
            const container = document.getElementById('goalProgress');
            const periodLabel = {
                pass: 'detta pass',
                vecka: 'denna vecka', 
                manad: 'denna månad',
                kvartal: 'detta kvartal',
                ar: 'detta år'
            }[goalPeriod];
            
            const html = `
                <div class="mb-2">
                    <strong>Målprogress för ${periodLabel}</strong>
                    <small style="color: var(--color-text-secondary); margin-left: 0.5rem;">
                        (Baserat på valt tidsomfång: ${timeRange})
                    </small>
                </div>
            ` + Object.entries(currentGoals).map(([type, goal]) => {
                const current = counts[type] || 0;
                const percentage = Math.min((current / goal) * 100, 100);
                const status = current >= goal ? 'success' : percentage >= 75 ? 'warning' : 'primary';
                
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span><strong>${type}</strong></span>
                            <span>${current} / ${goal}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${percentage}%; background: var(--color-${status}); transition: width 0.5s ease;"></div>
                        </div>
                        <div class="progress-text">${percentage.toFixed(1)}% uppnått</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        function getSelectedTypes() {
            return Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);
        }

        function updateChart() {
            const { calls, sales, allSales } = filterData();
            const granularity = document.getElementById('granularity').value;
            const chartType = document.querySelector('#chartTypeLine.btn-primary') ? 'line' : 'bar';
            const selectedTypes = getSelectedTypes();

            // Gruppera data enligt granularitet
            const groupedData = groupDataByGranularity(calls, sales, allSales, granularity);

            const ctx = document.getElementById('mainChart').getContext('2d');
            
            let labels;
            if (granularity === 'timme') {
                labels = Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`);
            } else {
                labels = Object.keys(groupedData).sort();
                if (labels.length === 0) {
                    labels = ['Inga data'];
                    groupedData['Inga data'] = {};
                }
                if (labels.length === 1) {
                    const currentLabel = labels[0];
                    labels = ['Föregående', currentLabel, 'Nästa'];
                    groupedData['Föregående'] = {};
                    groupedData['Nästa'] = {};
                }
            }

            if (currentChart) {
                currentChart.destroy();
            }

            const datasetConfig = {
                'Säkra meddelanden': { backgroundColor: 'rgba(46, 125, 50, 0.2)', borderColor: 'rgba(46, 125, 50, 1)' },
                'Informationsfullmakt': { backgroundColor: 'rgba(156, 39, 176, 0.2)', borderColor: 'rgba(156, 39, 176, 1)' },
                'Gula rutan': { backgroundColor: 'rgba(255, 193, 7, 0.2)', borderColor: 'rgba(255, 193, 7, 1)' },
                'Bolån': { backgroundColor: 'rgba(233, 30, 99, 0.2)', borderColor: 'rgba(233, 30, 99, 1)' },
                'Guldkund': { label: 'Guldkundssamtal', backgroundColor: 'rgba(255, 215, 0, 0.2)', borderColor: 'rgba(255, 215, 0, 1)' },
                'Bankärende': { label: 'Bankärende samtal', backgroundColor: 'rgba(255, 87, 34, 0.2)', borderColor: 'rgba(255, 87, 34, 1)' },
                'samtal': { label: 'Samtal', backgroundColor: 'rgba(11, 92, 171, 0.2)', borderColor: 'rgba(11, 92, 171, 1)' },
                'totalt': { label: 'Ärenden totalt', backgroundColor: 'rgba(100, 100, 100, 0.2)', borderColor: 'rgba(100, 100, 100, 1)' }
            };

            const datasets = selectedTypes.map(type => {
                const config = datasetConfig[type];
                return {
                    label: config.label || type,
                    data: labels.map(label => groupedData[label]?.[type] || 0),
                    backgroundColor: config.backgroundColor,
                    borderColor: config.borderColor,
                    borderWidth: 2,
                    fill: chartType === 'line' ? 'origin' : false,
                    tension: 0.4,
                    borderDash: config.borderDash || []
                };
            });

            const actualLabels = labels.filter(l => !['Föregående', 'Nästa', 'Inga data'].includes(l));
            const averages = {};

            const intervalSets = {};
            const addInterval = (type, timestamp) => {
                const key = getGroupingKey(timestamp, granularity);
                if (!intervalSets[type]) intervalSets[type] = new Set();
                intervalSets[type].add(key);
            };

            calls.forEach(call => {
                addInterval('samtal', call.timestamp);
                addInterval('totalt', call.timestamp);
                if (call.kategori === 'Guldkund') addInterval('Guldkund', call.timestamp);
                if (call.kategori === 'Bankärende') addInterval('Bankärende', call.timestamp);
            });

            sales.forEach(sale => {
                addInterval(sale.typ, sale.timestamp);
            });

            allSales.forEach(sale => {
                if (sale.typ === 'Säkra meddelanden' || sale.kanal === 'Säkra meddelanden') {
                    addInterval('Säkra meddelanden', sale.timestamp);
                    addInterval('totalt', sale.timestamp);
                }
            });

            selectedTypes.forEach(type => {
                const total = actualLabels.reduce((sum, label) => sum + (groupedData[label]?.[type] || 0), 0);
                const divisor = intervalSets[type] ? intervalSets[type].size : 0;
                averages[type] = total / (divisor || 1);
            });

            const avgBox = document.getElementById('averageBox');
            if (selectedTypes.length > 0) {
                avgBox.innerHTML = selectedTypes.map(type => `${type}: ${averages[type].toFixed(1)} per ${granularity}`).join('<br>');
                if (avgBox.dataset.open === 'true') {
                    avgBox.style.display = 'block';
                }
            } else {
                avgBox.style.display = 'none';
            }

            currentChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Statistik per ${granularity}${labels.length === 1 ? ' (enskilt datum)' : ''}`
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (labels.length === 3 && (context.label === 'Föregående' || context.label === 'Nästa')) {
                                        return '(Ingen data)';
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        function groupDataByGranularity(calls, sales, allSales, granularity) {
            const grouped = {};

            // Gruppera samtal
            calls.forEach(call => {
                const key = getGroupingKey(call.timestamp, granularity);
                if (!grouped[key]) grouped[key] = {};
                grouped[key].samtal = (grouped[key].samtal || 0) + 1;
                if (call.kategori === 'Guldkund') {
                    grouped[key].Guldkund = (grouped[key].Guldkund || 0) + 1;
                }
                if (call.kategori === 'Bankärende') {
                    grouped[key].Bankärende = (grouped[key].Bankärende || 0) + 1;
                }
            });

            // Gruppera försäljning (filtrerade)
            sales.forEach(sale => {
                const key = getGroupingKey(sale.timestamp, granularity);
                if (!grouped[key]) grouped[key] = {};
                grouped[key][sale.typ] = (grouped[key][sale.typ] || 0) + 1;
            });

            // Räkna säkra meddelanden oavsett klassificering
            const secureCounts = {};
            allSales.forEach(sale => {
                if (sale.typ === 'Säkra meddelanden' || sale.kanal === 'Säkra meddelanden') {
                    const key = getGroupingKey(sale.timestamp, granularity);
                    secureCounts[key] = (secureCounts[key] || 0) + 1;
                }
            });

            // Se till att alla nycklar finns
            Object.keys(secureCounts).forEach(key => {
                if (!grouped[key]) grouped[key] = {};
            });

            // Beräkna totalsumma
            Object.keys(grouped).forEach(key => {
                const data = grouped[key];
                const secureTotal = secureCounts[key] || 0;
                grouped[key].totalt = (data.samtal || 0) + secureTotal;
            });

            return grouped;
        }

        function getGroupingKey(timestamp, granularity) {
            const date = new Date(timestamp);

            switch (granularity) {
                case 'timme':
                    return `${date.getHours().toString().padStart(2, '0')}:00`;
                case 'pass':
                    return `Pass ${date.toLocaleDateString('sv-SE')}`;
                case 'dag':
                    return date.toLocaleDateString('sv-SE');
                case 'vecka':
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay() + 1);
                    return `Vecka ${weekStart.toLocaleDateString('sv-SE')}`;
                case 'manad':
                    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                case 'kvartal':
                    const quarter = Math.floor(date.getMonth() / 3) + 1;
                    return `${date.getFullYear()} Q${quarter}`;
                case 'ar':
                    return date.getFullYear().toString();
                default:
                    return date.toLocaleDateString('sv-SE');
            }
        }

        function updateTable() {
            const { calls, sales, allSales } = filterData();
            const granularity = document.getElementById('granularity').value;
            const groupedData = groupDataByGranularity(calls, sales, allSales, granularity);
            const selectedTypes = getSelectedTypes();

            const thead = document.getElementById('statsTableHead');
            const tbody = document.getElementById('statsTableBody');

            const headersMap = {
                'samtal': 'Samtal',
                'Guldkund': 'Guldkundssamtal',
                'Bankärende': 'Bankärende samtal',
                'Säkra meddelanden': 'Säkra meddelanden',
                'Informationsfullmakt': 'Informationsfullmakt',
                'Gula rutan': 'Gula rutan',
                'Bolån': 'Bolån',
                'totalt': 'Ärenden totalt'
            };

            thead.innerHTML = `<tr><th>${granularity.charAt(0).toUpperCase() + granularity.slice(1)}</th>` +
                selectedTypes.map(type => `<th>${headersMap[type]}</th>`).join('') + `</tr>`;

            let labels;
            if (granularity === 'timme') {
                labels = Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`);
            } else {
                labels = Object.keys(groupedData).sort();
                if (labels.length === 0) {
                    labels = ['Inga data'];
                    groupedData['Inga data'] = {};
                }
                if (labels.length === 1) {
                    const currentLabel = labels[0];
                    labels = ['Föregående', currentLabel, 'Nästa'];
                    groupedData['Föregående'] = {};
                    groupedData['Nästa'] = {};
                }
            }

            const rows = labels.map(label => {
                const data = groupedData[label] || {};
                const cells = selectedTypes.map(type => data[type] || 0).join('</td><td>');
                return `<tr><td>${label}</td><td>${cells}</td></tr>`;
            }).join('');

            tbody.innerHTML = rows;
        }

        function exportTableData() {
            const table = document.getElementById('statsTable');
            const csv = [];
            
            // Lägg till rubrik
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
            csv.push(headers.join(','));
            
            // Lägg till rader
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            if (rows.length === 0) {
                showToast('Ingen data att exportera', 'error');
                return;
            }
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent);
                csv.push(cells.join(','));
            });
            
            // Skapa och ladda ner fil
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `kundservice-bank-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            showToast('Tabell exporterad');
        }
        
        // ====================
        // IMPORT/EXPORT-HANTERING
        // ====================
        
        function initDataManagement() {
            const exportButton = document.getElementById('exportData');
            const importInput = document.getElementById('importData');
            
            exportButton.addEventListener('click', exportAllData);
            importInput.addEventListener('change', importData);
        }
        
        function exportAllData() {
            const calls = getLocalStorage('ksCalls', []);
            const sales = getLocalStorage('ksSales', []);
            const goals = getLocalStorage('ksGoals', DEFAULT_GOALS);

            const escape = val => {
                const str = val !== undefined && val !== null ? String(val) : '';
                return '"' + str.replace(/"/g, '""') + '"';
            };

            const lines = [];

            if (calls.length > 0) {
                lines.push('dataset,typ,kategori,beskrivning,vad_gick_bra,forbattra,stjarna_generellt,stjarna_kund,stjarna_insats,samtalstid_min,timestamp');
                calls.forEach(c => {
                    lines.push([
                        'call',
                        escape(c.typ),
                        escape(c.kategori),
                        escape(c.beskrivning),
                        escape(c.vad_gick_bra),
                        escape(c.forbattra),
                        escape(c.stjarna_generellt),
                        escape(c.stjarna_kund),
                        escape(c.stjarna_insats),
                        escape(c.samtalstid_min),
                        escape(c.timestamp)
                    ].join(','));
                });
                lines.push('');
            }

            if (sales.length > 0) {
                lines.push('dataset,typ,kanal,tagg,timestamp');
                sales.forEach(s => {
                    lines.push([
                        'sale',
                        escape(s.typ),
                        escape(s.kanal),
                        escape(s.tagg),
                        escape(s.timestamp)
                    ].join(','));
                });
                lines.push('');
            }

            lines.push('period,typ,mal');
            Object.entries(goals).forEach(([period, obj]) => {
                Object.entries(obj).forEach(([t, val]) => {
                    lines.push([period, t, val].join(','));
                });
            });

            const csvContent = lines.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ks-data-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);

            showToast('All data har exporterats');
        }
        
        // Hjälpfunktion för att parsa en CSV-rad
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Parser för äldre CSV-format med dagliga summeringar
        function parseDailySalesCSV(lines) {
            const sales = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const [date, sakraMedd, info, gula, bolan, sakraDigitala, sakraUtanf, bolanSM, bolanIn, bolanUt] = parseCSVLine(lines[i]);

                const baseDate = new Date(date);
                if (isNaN(baseDate)) continue;

                const addEntries = (count, type, kanal = null) => {
                    const n = Number(count) || 0;
                    for (let j = 0; j < n; j++) {
                        const ts = new Date(baseDate);
                        ts.setHours(12 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 60));
                        sales.push({ typ: type, kanal, timestamp: ts.toISOString() });
                    }
                };

                addEntries(sakraMedd, 'Säkra meddelanden');
                addEntries(info, 'Informationsfullmakt');
                addEntries(gula, 'Gula rutan');
                addEntries(bolanSM, 'Bolån', 'Säkra meddelanden');
                addEntries(bolanIn, 'Bolån', 'Telefonsamtal inringning');
                addEntries(bolanUt, 'Bolån', 'Telefonsamtal utringning');

                const totalBolan = Number(bolan) || 0;
                const channelBolan = (Number(bolanSM) || 0) + (Number(bolanIn) || 0) + (Number(bolanUt) || 0);
                if (totalBolan > channelBolan) {
                    addEntries(totalBolan - channelBolan, 'Bolån');
                }
            }

            return { ksCalls: [], ksSales: sales, ksGoals: {} };
        }

        // Parser för exporterat CSV-format
        function parseCSVData(text) {
            const lines = text.trim().split(/\r?\n/);

            // Stöd för enklare dagligt säljformat
            const header = parseCSVLine(lines[0] || '');
            if (header[0] === 'Datum') {
                return parseDailySalesCSV(lines);
            }

            let index = 0;
            const calls = [];
            const sales = [];
            const goals = {};

            if (lines[index]?.startsWith('dataset,typ,kategori')) {
                index++;
                while (index < lines.length && lines[index].trim() !== '') {
                    const [_, typ, kategori, beskrivning, vad_gick_bra, forbattra, stjarna_generellt, stjarna_kund, stjarna_insats, samtalstid_min, timestamp] = parseCSVLine(lines[index]);
                    calls.push({
                        typ,
                        kategori,
                        beskrivning,
                        vad_gick_bra,
                        forbattra,
                        stjarna_generellt: Number(stjarna_generellt),
                        stjarna_kund: Number(stjarna_kund),
                        stjarna_insats: Number(stjarna_insats),
                        samtalstid_min: Number(samtalstid_min),
                        timestamp
                    });
                    index++;
                }
                index++;
            }

            if (lines[index]?.startsWith('dataset,typ,kanal,tagg,timestamp')) {
                index++;
                while (index < lines.length && lines[index].trim() !== '') {
                    const [_, typ, kanal, tagg, timestamp] = parseCSVLine(lines[index]);
                    sales.push({ typ, kanal, tagg, timestamp });
                    index++;
                }
                index++;
            }

            if (lines[index]?.startsWith('period,typ,mal')) {
                index++;
                while (index < lines.length && lines[index].trim() !== '') {
                    const [period, typ, mal] = parseCSVLine(lines[index]);
                    if (!goals[period]) goals[period] = {};
                    goals[period][typ] = Number(mal);
                    index++;
                }
            }

            return { ksCalls: calls, ksSales: sales, ksGoals: goals };
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const text = event.target.result;
                    let data;
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        data = parseCSVData(text);
                    } else {
                        data = JSON.parse(text);
                    }

                    if (!data.ksCalls && !data.ksSales && !data.ksGoals) {
                        throw new Error('Ogiltigt dataformat');
                    }

                    if (!confirm('Detta kommer att ersätta all befintlig data. Fortsätt?')) {
                        return;
                    }

                    if (data.ksCalls) setLocalStorage('ksCalls', data.ksCalls);
                    if (data.ksSales) setLocalStorage('ksSales', data.ksSales);
                    if (data.ksPass) setLocalStorage('ksPass', data.ksPass);
                    if (data.ksGoals) setLocalStorage('ksGoals', data.ksGoals);

                    showToast('Data har importerats');

                    updateRecentCalls();
                    updateAllCalls();
                    updateSalesCounters();
                    updateStatistics();

                } catch (error) {
                    console.error('Import fel:', error);
                    showToast('Fel vid import av data', 'error');
                }
            };

            reader.readAsText(file);
            e.target.value = ''; // Återställ input
        }
        
        // ====================
        // INSTÄLLNINGAR-HANTERING
        // ====================
        
        function initSettings() {
            const populateButton = document.getElementById('populateExampleData');
            const deleteButton = document.getElementById('deleteAllData');
            const confirmInput = document.getElementById('confirmDelete');
            
            // Populera exempeldata
            populateButton.addEventListener('click', populateExampleData);
            
            // Aktivera/inaktivera radera-knapp baserat på bekräftelse
            confirmInput.addEventListener('input', (e) => {
                const isValid = e.target.value.trim() === 'RADERA';
                deleteButton.disabled = !isValid;
                deleteButton.style.opacity = isValid ? '1' : '0.5';
            });
            
            // Radera all data
            deleteButton.addEventListener('click', deleteAllData);
        }
        
        function populateExampleData() {
            if (!confirm('Detta kommer lägga till exempeldata. Fortsätt?')) {
                return;
            }
            
            const now = new Date();
            const exampleCalls = [];
            const exampleSales = [];
            
            // Skapa exempeldata för de senaste 30 dagarna
            for (let i = 0; i < 30; i++) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                
                // Variera antalet baserat på dag
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const callCount = isWeekend ? Math.floor(Math.random() * 3) : Math.floor(Math.random() * 8) + 2;
                const salesMultiplier = isWeekend ? 0.3 : 1;
                
                // Skapa samtal för dagen
                for (let j = 0; j < callCount; j++) {
                    const callTime = new Date(date);
                    callTime.setHours(8 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 60));
                    
                    exampleCalls.push({
                        id: generateUUID(),
                        typ: Math.random() > 0.3 ? 'Telefonsamtal' : 'KF',
                        kategori: Math.random() > 0.5 ? 'Guldkund' : 'Bankärende',
                        stjarna_generellt: Math.floor(Math.random() * 2) + 4, // 4-5 stjärnor
                        stjarna_kund: Math.floor(Math.random() * 3) + 3, // 3-5 stjärnor
                        stjarna_insats: Math.floor(Math.random() * 2) + 4, // 4-5 stjärnor
                        beskrivning: [
                            'Kund ringde angående kontofrågor',
                            'Samtal om lånevillkor',
                            'Allmänt kundserviceärende',
                            'Uppföljning på tidigare ärende',
                            'Diskussion om banktjänster'
                        ][Math.floor(Math.random() * 5)],
                        vad_gick_bra: [
                            'Kunden var nöjd med servicen',
                            'Löste kundens problem snabbt',
                            'Bra kommunikation under samtalet',
                            'Kunde hjälpa med flera frågor',
                            'Professionell hantering av ärendet'
                        ][Math.floor(Math.random() * 5)],
                        forbattra: [
                            'Kunde varit mer proaktiv',
                            'Bättre uppföljning nästa gång',
                            'Mer detaljerad förklaring',
                            'Snabbare lösning',
                            ''
                        ][Math.floor(Math.random() * 5)],
                        samtalstid_min: Math.floor(Math.random() * 25) + 5, // 5-30 min
                        timestamp: callTime.toISOString()
                    });
                }
                
                // Skapa försäljningsdata för dagen
                const sakraCount = Math.floor((Math.random() * 15 + 5) * salesMultiplier);
                const infoCount = Math.floor((Math.random() * 3 + 1) * salesMultiplier);
                const gulaCount = Math.floor((Math.random() * 8 + 2) * salesMultiplier);
                const bolanCount = Math.floor((Math.random() * 2) * salesMultiplier);
                
                // Säkra meddelanden
                for (let k = 0; k < sakraCount; k++) {
                    const saleTime = new Date(date);
                    saleTime.setHours(8 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 60));
                    
                    exampleSales.push({
                        id: generateUUID(),
                        typ: 'Säkra meddelanden',
                        tagg: Math.random() > 0.7 ? 'Tid utanför digitala' : 'Digitala',
                        timestamp: saleTime.toISOString()
                    });
                }
                
                // Informationsfullmakt
                for (let k = 0; k < infoCount; k++) {
                    const saleTime = new Date(date);
                    saleTime.setHours(8 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 60));
                    
                    exampleSales.push({
                        id: generateUUID(),
                        typ: 'Informationsfullmakt',
                        timestamp: saleTime.toISOString()
                    });
                }
                
                // Gula rutan
                for (let k = 0; k < gulaCount; k++) {
                    const saleTime = new Date(date);
                    saleTime.setHours(8 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 60));
                    
                    exampleSales.push({
                        id: generateUUID(),
                        typ: 'Gula rutan',
                        timestamp: saleTime.toISOString()
                    });
                }
                
                // Bolån
                for (let k = 0; k < bolanCount; k++) {
                    const saleTime = new Date(date);
                    saleTime.setHours(8 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 60));
                    
                    const kanaler = ['Säkra meddelanden', 'Telefonsamtal inringning', 'Telefonsamtal utringning'];
                    
                    exampleSales.push({
                        id: generateUUID(),
                        typ: 'Bolån',
                        kanal: kanaler[Math.floor(Math.random() * kanaler.length)],
                        timestamp: saleTime.toISOString()
                    });
                }
            }
            
            // Spara exempeldata
            const existingCalls = getLocalStorage('ksCalls', []);
            const existingSales = getLocalStorage('ksSales', []);
            
            setLocalStorage('ksCalls', [...existingCalls, ...exampleCalls]);
            setLocalStorage('ksSales', [...existingSales, ...exampleSales]);
            
            showToast(`Exempeldata tillagd: ${exampleCalls.length} samtal och ${exampleSales.length} säljpunkter`);

            // Uppdatera alla vyer
            updateRecentCalls();
            updateAllCalls();
            updateSalesCounters();
            updateStatistics();
        }
        
        function deleteAllData() {
            const confirmText = document.getElementById('confirmDelete').value.trim();
            
            if (confirmText !== 'RADERA') {
                showToast('Du måste skriva "RADERA" för att bekräfta', 'error');
                return;
            }
            
            if (!confirm('Är du säker på att du vill radera ALL data? Detta kan inte ångras.')) {
                return;
            }
            
            // Radera all data
            removeLocalStorage('ksCalls');
            removeLocalStorage('ksSales');
            removeLocalStorage('ksPass');
            removeLocalStorage('ksGoals');
            
            // Återställ mål till standard
            setLocalStorage('ksGoals', DEFAULT_GOALS);
            
            // Rensa bekräftelseinput
            document.getElementById('confirmDelete').value = '';
            document.getElementById('deleteAllData').disabled = true;
            
            showToast('All data har raderats');

            // Uppdatera alla vyer
            updateRecentCalls();
            updateAllCalls();
            updateSalesCounters();
            updateStatistics();
        }

        // ====================
        // ARBETSSTÖD
        // ====================

        function initArbetsstod() {
            const form = document.getElementById('caseWizardForm');
            if (!form) return;

           const handlingSelect = document.getElementById('handling');
           const handlingFritext = document.getElementById('handlingFritext');
            const sumInput = document.getElementById('summa');
            const sumUtland = document.getElementById('summaUtland');
            const utlandsLand = document.getElementById('utlandsLand');
           const avseendeSelect = document.getElementById('avseende');
           const avseendeBilkop = document.getElementById('avseendeBilkop');
            const avseendeSpar = document.getElementById('avseendeSpar');
            const avseendeFritext = document.getElementById('avseendeFritext');
            const ursprungSelect = document.getElementById('ursprung');
            const ursprungLanDetalj = document.getElementById('ursprungLanDetalj');
            const annatUnderlagLabel = document.getElementById('annatUnderlagLabel');
            const annatUnderlag = document.getElementById('annatUnderlag');
            const ursprungFritext = document.getElementById('ursprungFritext');
            const kycText = document.getElementById('kycText');
            const avtalText = document.getElementById('avtalText');
            const caseOutput = document.getElementById('caseOutput');
            const activityOutput = document.getElementById('activityOutput');

            const typeMap = {
                swish: { behov: 'höja sin swishgräns', process: 'höjningen', bankid: true },
                overforing: { behov: 'göra en större överföring', process: 'överföringen', bankid: false },
                betalning: { behov: 'göra en större betalning', process: 'betalningen', bankid: false },
                utlands: { behov: 'göra en utlandsbetalning', process: 'utlandsbetalningen', bankid: false },
                fritext: { behov: '', process: '', bankid: false }
            };

            const handlingMap = {
                kop: { phrase: 'göra ett köp på', desc: 'köp', comment: 'ett köp' },
                overfora: { phrase: 'överföra', desc: 'överföring', comment: 'en överföring' },
                betala: { phrase: 'betala', desc: 'betalning', comment: 'en betalning' },
                utlandsbetalning: { phrase: 'göra en utlandsbetalning på', desc: 'utlandsbetalning', comment: 'en utlandsbetalning' },
                fritext: { phrase: '', desc: '', comment: '' }
            };

           function updateDynamicFields() {
                handlingFritext.style.display = handlingSelect.value === 'fritext' ? 'block' : 'none';

                const isUtlands = handlingSelect.value === 'utlandsbetalning' || form.caseType.value === 'utlands';
                sumInput.style.display = isUtlands ? 'none' : 'block';
                sumUtland.style.display = isUtlands ? 'block' : 'none';
                utlandsLand.style.display = isUtlands ? 'block' : 'none';

                avseendeBilkop.style.display = avseendeSelect.value === 'bilkop' ? 'block' : 'none';
                avseendeSpar.style.display = avseendeSelect.value === 'sparande' ? 'block' : 'none';
                avseendeFritext.style.display = avseendeSelect.value === 'fritext' || (avseendeSelect.value === 'sparande' && avseendeSpar.value === 'Fritext') ? 'block' : 'none';

                ursprungLanDetalj.style.display = ursprungSelect.value === 'lan' ? 'block' : 'none';
                annatUnderlagLabel.style.display = ursprungSelect.value === 'annat' ? 'block' : 'none';
                ursprungFritext.style.display = ursprungSelect.value === 'fritext' ? 'block' : 'none';

                updateKycAvtal();
            }

            function updateKycAvtal() {
                const type = form.caseType.value;
                const info = typeMap[type];
                kycText.value = `Finner syfte och art med ${info.process}. KYC ok.${info.bankid ? ' Gammalt BankID.' : ''}`;
                avtalText.value = `Skickar avtal för DS avseende ${info.process}.`;
            }

            function renderOutputs() {
                const type = form.caseType.value;
                const handlingVal = handlingSelect.value;
                const isUtlands = type === 'utlands' || handlingVal === 'utlandsbetalning';
                const sum = isUtlands ? sumUtland.value : (sumInput.value || '0');
                const land = utlandsLand.value;
                const info = typeMap[type];

                let handlingText = handlingMap[handlingVal].phrase;
                let handlingDesc = handlingMap[handlingVal].desc;
                let handlingComment = handlingMap[handlingVal].comment;
                if (handlingVal === 'fritext') {
                    handlingText = handlingFritext.value.trim();
                    handlingDesc = handlingText;
                    handlingComment = handlingText;
                }

                let avseendeText = '';
                if (avseendeSelect.value === 'bilkop') {
                    avseendeText = `ett bilköp, ${avseendeBilkop.value}`;
                } else if (avseendeSelect.value === 'sparande') {
                    const val = avseendeSpar.value;
                    if (val === 'Fritext') {
                        avseendeText = `sparande i annat institut, ${avseendeFritext.value}`;
                    } else {
                        avseendeText = `sparande i annat institut, ${val}`;
                    }
                } else if (avseendeSelect.value === 'fritext') {
                    avseendeText = avseendeFritext.value;
                }

                if (isUtlands && land) {
                    avseendeText = avseendeText ? `${avseendeText} till ${land}` : `${land}`;
                }

                let ursprungText = '';
                if (ursprungSelect.value === 'lon') {
                    ursprungText = 'eget sparande av lön vilket går att följa i LÄNK';
                } else if (ursprungSelect.value === 'lan') {
                    if (ursprungLanDetalj.value === 'skuldebrev') {
                        ursprungText = 'ett lån, skuldebrev inskickat som underlag';
                    } else {
                        ursprungText = 'ett lån, finns inget upprättat skuldebrev, men finner det rimligt utifrån kundens berättelse';
                    }
                } else if (ursprungSelect.value === 'annat') {
                    ursprungText = `eget sparande i annat institut${annatUnderlag.checked ? ', underlag inskickat' : ''}`;
                } else {
                    ursprungText = ursprungFritext.value;
                }

                const sumText = isUtlands ? sum : `${sum} tkr`;
                const handlingFull = handlingText ? `${handlingText} ${sumText}` : '';
                const caseText = `Kund ska ${handlingFull} avseende ${avseendeText} och behöver således ${info.behov}.

Pengarna kommer från ${ursprungText}.

${kycText.value}

${avtalText.value}`;
                caseOutput.value = caseText;
                caseOutput.style.height = 'auto';
                caseOutput.style.height = caseOutput.scrollHeight + 'px';

                let oversikt = '';
                if (type === 'swish') {
                    oversikt = `TF Swish ${sumText}`;
                } else if (type === 'utlands' || handlingVal === 'utlandsbetalning') {
                    oversikt = `Utlandsbetalning ${sumText}`;
                } else if (type === 'overforing') {
                    oversikt = `Överföring ${sumText}`;
                } else if (type === 'betalning') {
                    oversikt = `Betalning ${sumText}`;
                } else {
                    oversikt = `${handlingDesc} ${sumText}`.trim();
                }
                let kommentar = '';
                if (type === 'swish') {
                    kommentar = `Hjälper kund höja sin swishgräns tillfälligt, avseende ${avseendeText}.`;
                } else {
                    kommentar = `Hjälper kund med ${handlingComment}, avseende ${avseendeText}.`;
                }
                activityOutput.value = `Översikt: ${oversikt}
Kommentar: ${kommentar}`;
            }

            handlingSelect.addEventListener('change', updateDynamicFields);
            form.querySelectorAll('input[name="caseType"]').forEach(r => r.addEventListener('change', updateDynamicFields));
            avseendeSelect.addEventListener('change', updateDynamicFields);
            avseendeSpar.addEventListener('change', updateDynamicFields);
            ursprungSelect.addEventListener('change', updateDynamicFields);

            document.getElementById('generateCase').addEventListener('click', () => {
                renderOutputs();
                const data = {
                    caseType: form.caseType.value,
                    handling: handlingSelect.value,
                    handlingFritext: handlingFritext.value,
                    summa: sumInput.value,
                    summaUtland: sumUtland.value,
                    utlandsLand: utlandsLand.value,
                    avseende: avseendeSelect.value,
                    avseendeBilkop: avseendeBilkop.value,
                    avseendeSpar: avseendeSpar.value,
                    avseendeFritext: avseendeFritext.value,
                    ursprung: ursprungSelect.value,
                    ursprungLanDetalj: ursprungLanDetalj.value,
                    annatUnderlag: annatUnderlag.checked,
                    ursprungFritext: ursprungFritext.value
                };
                setLocalStorage('ksCaseWizardDraft', data);
            });

            document.getElementById('copyCaseBtn').addEventListener('click', () => copyToClipboard('caseOutput'));
            document.getElementById('copyActivityBtn').addEventListener('click', () => copyToClipboard('activityOutput'));

            const draft = getLocalStorage('ksCaseWizardDraft', null);
            if (draft) {
                if (draft.caseType) {
                    form.querySelector(`input[name="caseType"][value="${draft.caseType}"]`).checked = true;
                }
                handlingSelect.value = draft.handling || 'kop';
                handlingFritext.value = draft.handlingFritext || '';
                sumInput.value = draft.summa || '';
                sumUtland.value = draft.summaUtland || '';
                utlandsLand.value = draft.utlandsLand || '';
                avseendeSelect.value = draft.avseende || '';
                avseendeBilkop.value = draft.avseendeBilkop || 'från privatperson';
                avseendeSpar.value = draft.avseendeSpar || 'Avanza';
                avseendeFritext.value = draft.avseendeFritext || '';
                ursprungSelect.value = draft.ursprung || 'lon';
                ursprungLanDetalj.value = draft.ursprungLanDetalj || 'skuldebrev';
                annatUnderlag.checked = draft.annatUnderlag || false;
                ursprungFritext.value = draft.ursprungFritext || '';
            }

            updateDynamicFields();
            renderOutputs();
        }

        function copyToClipboard(id) {
            const text = document.getElementById(id).value;
            navigator.clipboard.writeText(text).then(() => showToast('Text kopierad'));
        }
        
        // ====================
        // INITIERING AV APPLIKATION
        // ====================
        
        async function initApp() {
            await initDB();
            initTheme();
            initTabs();
            initLoggTabs();
            initCallTabs();
            initStarRatings();
            initCallForm();
            initSalesGoals();
            initStatistics();
            initDataManagement();
            initSettings();
            initArbetsstod();

            // Sätt initial data om den inte finns
            if (!getLocalStorage('ksGoals')) {
                setLocalStorage('ksGoals', DEFAULT_GOALS);
            }

            console.log('Kundservice Bank app initierad - version 2.0');
        }
        
        // Starta appen när DOM är redo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
        
    </script>
</body>
</html>
